/*! Copyright (c) Epic Systems Corporation 2017-2018 */
(function ClassDefinition(){var c="hidden",i="expanded",h="collapsed",k="default",a="",b=null,m="#recipients",d=true,f="#dmform",e="matchColumnHeights",j="click",g="directmessage",o="images/ShareEverywhere/chart_info.png",l=$$WP.Strings.getNamespace(g);$$WP.Utilities.guaranteeExistence($$WP,"Controllers.ShareEverywhere");var n=function DirectMessageController(i){var c="input,textarea,select",a=this;a.proxify("_populateRecipients","_initializeDirectMessageSection","_adjustGhostText","_addInfoPopup","_getAuthorElement","_saveForm","_getNoteTab","_getFormElement");var h=a._setValidationSettings(),g=$afe.renderTemplate($$WP.Templates.ShareEverywhere.DirectMessage,h);i.safeAppend(g);g.show();a._getSubmitElement().on(j,$.proxy(a._submitClickEvent,a));a._getNoteTab().on(j,$.proxy(a._toggleNoteSection,a));$afe.select(c).blur(function(){$afe.jq(window).trigger(e)});var b=a;$afe.select(c).on("input paste",function(){$.proxy(b._saveForm(),b);$$WP.FormValidation.checkIfFormIsValid($afe.select(f),d)});$afe.onDocumentReady(function(){window.onmessage=function(a){a.data==="logout"&&logOut()};if(sessionStorage.sessId!==b._getSessIdElement().text()){sessionStorage.clear();sessionStorage.sessId=b._getSessIdElement().text()}if(sessionStorage.dmSubmitted==="true")b._displaySuccess();else b._getRecipients();$afe.jq(window).trigger(e)})};n.prototype={_getMessageElement:function(){return $afe.select("#message")},_getAuthorElement:function(){return $afe.select("#author")},_getTitleElement:function(){return $afe.select("#title")},_getTelephoneNumber:function(){return $afe.select("#telephoneNumber")},_getNPI:function(){return $afe.select("#NPI")},_getRecipientList:function(){return $afe.select(m)},_getSubmitElement:function(){return $afe.select("#submit")},_getFormElement:function(){return $afe.select(f)},_getNoteTab:function(){return $afe.select("#note_tab")},_getResultElement:function(a){return a?$afe.select("#successResult"):$afe.select("#failResult")},_getDmErrorElement:function(){return $afe.select("#dm_error_message")},_getSessIdElement:function(){return $afe.select("#sessId")},_submitClickEvent:function(){if(!$$WP.FormValidation.checkIfFormIsValid($afe.select(f),d))return;var c=this,e=new $$WPComp.MessageComponent({TitleText:l.getString("SubmitPopupTitle"),Message:l.getString("SubmitPopupMessage"),callback:$.proxy(c._submitPopupHandler,c),ToolbarButtons:[new $$WPComp.ComplexObjects.Button(l.getString("SubmitPopupConfirm"),b,"nextstep",a),new $$WPComp.ComplexObjects.Button(l.getString("SubmitPopupCancel"),b,"cancelworkflow",a)]});$$WPUtil.quickPopup(e)},_submitPopupHandler:function(f){var b=this;if(f==="toolbar1"||f==="close")return;var h=b._getMessageElement().val(),i=b._getTitleElement().val(),c=b._getAuthorElement().val(),g=b._getTelephoneNumber().val(),j=b._getNPI().val(),e=b._getRecipientList().val();if(c==="undefined"||!c)c=b._getAuthorElement().safeAttr("placeholder");if(e===k)e=a;var d=b;getCSRFTokenAsQS(function(){$.post({url:makeLink("ShareEverywhere/ShareEverywhere/SendDirectMessage"),datatype:"json",data:{title:i,message:h,author:c,telephoneNumber:g,npi:j,recipient:e},success:$.proxy(d._submitSuccess,d),error:$.proxy(d._displayError,d)})})},_submitSuccess:function(){sessionStorage.dmSubmitted="true";sessionStorage.removeItem("author");sessionStorage.removeItem("title");sessionStorage.removeItem("message");sessionStorage.removeItem("telephoneNumber");sessionStorage.removeItem("npi");sessionStorage.removeItem("recipient");this._displaySuccess()},_displaySuccess:function(){this._getNoteTab().removeClass(h).removeClass(i);this._getNoteTab().off(j);this._displayResult(d)},_displayError:function(){this._displayResult(false)},_displayResult:function(a){var b=this._getResultElement(a);$alert=$(document.createElement("p"));if(a){$alert.text(l.getString("NoteSubmissionSuccess"));var d=this._getFormElement();d.addClass(c)}else $alert.text(l.getString("NoteSubmissionFailure"));b.safeAppend($alert);$afe.jq(window).trigger(e)},_saveForm:function(){var a=this;sessionStorage.author=a._getAuthorElement().val();sessionStorage.title=a._getTitleElement().val();sessionStorage.message=a._getMessageElement().val();sessionStorage.telephoneNumber=a._getTelephoneNumber().val();sessionStorage.npi=a._getNPI().val();sessionStorage.recipient=a._getRecipientList().val()},_loadForm:function(){var a=this;a._getAuthorElement().val(sessionStorage.author);a._getTitleElement().val(sessionStorage.title);a._getMessageElement().val(sessionStorage.message);a._getTelephoneNumber().val(sessionStorage.telephoneNumber);a._getNPI().val(sessionStorage.npi);if(sessionStorage.recipient===undefined)a._getRecipientList().val(k);else a._getRecipientList().val(sessionStorage.recipient)},_toggleNoteSection:function(){var a=this,b=a._getFormElement();if(b.hasClass(c)){sessionStorage.noteExpanded=d;a._getNoteTab().addClass(i);a._getNoteTab().removeClass(h);b.removeClass(c)}else{sessionStorage.noteExpanded=false;a._getNoteTab().addClass(h);a._getNoteTab().removeClass(i);b.addClass(c)}$afe.jq(window).trigger(e)},_setValidationSettings:function(){var b=new $$WP.FormValidation.ValidationSettings({required:d,nullValue:k}),a={ValidationSettings:b};return a},_adjustGhostText:function(){var b="ghosted",c=this;c._getNPI().val()!==a&&$afe.select("#npiGhost").addClass(b);c._getTelephoneNumber().val()!==a&&$afe.select("#telephoneNumberGhost").addClass(b);c._getTitleElement().val()!==a&&$afe.select("#titleGhost").addClass(b);c._getMessageElement().val()!==a&&$afe.select("#messageGhost").addClass(b)},_getRecipients:function(){var a=this;getCSRFTokenAsQS(function(){$.ajax({type:"POST",url:makeLink("ShareEverywhere/ShareEverywhere/GetRecipients"),data:{},datatype:"json",success:$.proxy(a._populateRecipients,a),error:$.proxy(a._populateRecipients,a)})})},_populateRecipients:function(f){var e="#noRecipients",b=a;if(f.status!=500&&f.status!=404)b=f.RecipientsList;if(b.length>0)for(var h=$afe.select(m),d=0;d<b.length;d++)if(b[d].IsPCP==="1")h.append(new Option(b[d].Name+" "+$$WP.Strings.get("RecipientPCPIndicator",g),b[d].ID));else h.append(new Option(b[d].Name,b[d].ID));else{$afe.select("#recipientGhost").addClass(c);$afe.select(e).removeClass(c);$afe.select(e).removeAttr("aria-hidden")}this._initializeDirectMessageSection()},_initializeDirectMessageSection:function(){var b=this;b._loadForm();b._adjustGhostText();b._addInfoPopup();if(b._getAuthorElement().val()===a){b._getAuthorElement().val($afe.select("#author_name").text());b._saveForm()}$$WP.FormValidation.checkIfFormIsValid($afe.select(f),d);if(sessionStorage.noteExpanded==="false"){b._getNoteTab().addClass(h);b._getNoteTab().removeClass(i);b._getFormElement().addClass(c)}$afe.jq(window).trigger(e);$$WP.FormValidation.initializeDOMSubtree($afe.select(f))},_addInfoPopup:function(){var c="InfoBubbleHeader",d=$afe.select("#infoPopupContainer");WP.Controls.InfoButton(d,$$WP.Strings.get("InfoBubbleText",g),a,$$WP.Strings.get(c,g),$$WP.Strings.get(c,g),b,b,b,b,b,o)}};$$WP.Controllers.ShareEverywhere.DirectMessageController=n;n.extend($$WP.Controllers.Controller,"WP$ShareEverywhere$Controllers$DirectMessageController")})()