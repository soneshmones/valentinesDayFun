(function ClassDefinition(){var t="continue",s="previousstep",r="data-is-editing",k="model-id",q="keypress",j="[data-function='edit-label-input']",i="click",m="[data-function='upload']",p="FileNotAcceptedPopupAnotherUploadErrorText",o="FileNotAcceptedPopupWrongExtensionErrorText",e="FileNotAcceptedPopupButtonText",d="FileNotAcceptedPopupHeaderText",c=true,l="json",f="POST",a=null,b=false,n="DocumentId";$$WP.Utilities.guaranteeExistence($$WP,"Upload.Controllers");var u=function UploadController(f,g,c,h,e){var a=this,d;a.WP$Controllers$Controller();a._viewContainer$=f;a._documentCollection=new $$WP.Common.ModelCollection([{propertyNames:n,storeAs:"single"}],[],[]);a._isConfigLoaded=b;a._settings=g;a._documentModelClass=h||$$WP.Upload.Models.Document;a.__afterRefreshView=e;if(c&&c.length>0)for(d=0;d<c.length;++d)a._documentCollection.add(new a._documentModelClass(c[d]));a.__pendingUploadFiles=[];a.proxify("_onAddButtonClicked","_onRemoveButtonClicked","_onEditButtonClicked","_uploadFile","_onFileNameEdited","__onDropFiles","__onDragEnter","__onDragLeave","_onFileNameInputKeyPressed","_onViewButtonClicked");a._getConfig();a._refreshView();a._attachEventHandlers()};u.prototype={_viewContainer$:a,_settings:a,_documentCollection:a,_documentModelClass:a,__afterRefreshView:a,_isConfigLoaded:a,_getConfig:function _getConfig(){var a=this;if(a._settings.ConfigUrl){a._isConfigLoaded=b;a.__isFunction(a._settings.onConfigStart)&&a._settings.onConfigStart();var d=a._settings.UseGet?"GET":f;$.ajax({type:d,dataType:l,data:$$WPUtil.postify(a._settings.ContextData),url:a._settings.ConfigUrl}).success($.proxy(a.__onConfigSuccess,a)).fail($.proxy(a.__onConfigFail,a))}else a._isConfigLoaded=c},__onConfigSuccess:function __onConfigSuccess(d){var a=this;if(d.Success){a._isConfigLoaded=c;var b=new $$WP.Upload.Models.UploadConfiguration(d.Data);a._settings.AllowedExtensions=b.AllowedExtensions;a._settings.AllowedImageAndDocumentExtensions=b.AllowedImageAndDocumentExtensions;a._settings.AllowedVideoExtensions=b.AllowedVideoExtensions;a._settings.MaxAllowedImageSize=b.MaxAllowedImageSize;a._settings.MaxAllowedVideoSize=b.MaxAllowedVideoSize;a._settings.MaxFilesAllowed=b.MaxFilesAllowed;a._settings.IsPhotoForPatientsChart=b.IsPhotoForPatientsChart;a._refreshView();if(a.__isFunction(a._settings.onConfigSucess))a._settings.onConfigSucess(a._settings,d.Data)}else a.__onConfigFail(d)},__onConfigFail:function __onConfigFail(a){this._handleCommunicationFail(h.GetConfig,a)},__pendingUploadFiles:a,_uploadFile:function _uploadFile(){var b=this._viewContainer$.find(".upload-input[data-function='upload-core']"),a=b.prop("files");this.__uploadFileCore(a)},__uploadFileCore:function __uploadFileCore(c){var a=this,b,f;if(a._settings.MaxFilesAllowed<a._documentCollection.Models.length+c.length){a.__isFunction(a._settings.onUploadFail)&&a._settings.onUploadFail();a._showErrorMessage("FileNotAcceptedPopupTooManyFilesErrorText",d,e);return}for(b=0;b<c.length;++b){f=a._settings.IsFileAceptable(c[b].name,c[b].size);if(f!==0){a.__isFunction(a._settings.onUploadFail)&&a._settings.onUploadFail();switch(f){case 1:a._showErrorMessage(o,d,e);break;case 2:if(a._settings.MaxAllowedImageSize>=1024)a._showErrorMessage("FileNotAcceptedPopupLargeImageErrorText",d,e);else a._showErrorMessage("FileNotAcceptedPopupLargeImageErrorTextKb",d,e);break;case 3:a._showErrorMessage("FileNotAcceptedPopupLargeVideoErrorText",d,e)}return}}if(!g){for(b=0;b<c.length;++b)if($.isFunction(a._settings.ConfirmFunction))a._settings.ConfirmFunction.call(a._settings.MasterController,c[b],a._settings.ConfirmationViewModel,a.__pushToPending,a);else a.__pendingUploadFiles.push(c[b]);!a._settings.ConfirmFunction&&a.__flushUploadQueue()}else a._showErrorMessage(p,d,e)},__pushToPending:function(a){this.__pendingUploadFiles.push(a);this.__flushUploadQueue()},__flushUploadQueue:function __flushUploadQueue(){var a=this,i=(a.__pendingUploadFiles||[]).length,h,d;if(i===0){g=b;a._refreshView(c);return}a.__isFunction(a._settings.onUploadStart)&&a._settings.onUploadStart();g=c;a._refreshView(c);h=a.__pendingUploadFiles.shift();d=new FormData;d.append("__file__[]",h);a._serializeContextToFormData(d,a._settings.ContextData);if(a._settings.FromVBPage){var e=a;getCSRFTokenAsQS(function(){$.ajax({type:f,processData:b,contentType:b,data:d,url:e._settings.UploadUrl}).success($.proxy(e.__onUploadSuccess,e)).fail($.proxy(e.__onUploadFail,e))})}else $.ajax({type:f,processData:b,contentType:b,data:d,url:a._settings.UploadUrl}).success($.proxy(a.__onUploadSuccess,a)).fail($.proxy(a.__onUploadFail,a))},__onUploadSuccess:function __onUploadSuccess(b){var a=this,d,e,c;if(b.Success){c=[];e=(b.Data||[]).length;for(d=0;d<e;++d)c.push(new a._documentModelClass(b.Data[d]));a._documentCollection.addRange(c);a._refreshView();if(a.__isFunction(a._settings.onUploadSuccess))a._settings.onUploadSuccess(c,b);a._viewContainer$.find(".upload--edit-icon").last().focus();a.__flushUploadQueue()}else a.__onUploadFail(b)},__onUploadFail:function __onUploadFail(d){var a=this;g=b;a.__isFunction(a._settings.onUploadFail)&&a._settings.onUploadFail();a.__pendingUploadFiles=[];a._refreshView(c);a._handleCommunicationFail(h.UploadFile,d)},_editFileName:function _editFileName(c){var a=this,b=c.toRawObject()||{};b.ContextData=a._settings.ContextData;a.__isFunction(a._settings.onEditStart)&&a._settings.onEditStart();$.ajax({type:f,url:a._settings.EditUrl,data:$$WPUtil.postify(b),dataType:l}).success($.proxy(a._editFileNameSuccess,a)).fail($.proxy(a.__editFileNameFail,a))},_editFileNameSuccess:function _editFileNameSuccess(b){var a=this;if(b.Success){var c=a._documentCollection.getFirstInIndex(n,b.Data.DocumentId);if(a.__isFunction(a._settings.onEditSuccess))a._settings.onEditSuccess(c,b)}else a.__editFileNameFail(b)},__editFileNameFail:function __editFileNameFail(a){this._handleCommunicationFail(h.EditFileName,a)},_deleteFile:function _deleteFile(c){var a=this,b=c.toRawObject()||{};b.ContextData=a._settings.ContextData;a.__isFunction(a._settings.onDeleteStart)&&a._settings.onDeleteStart();$.ajax({dataType:l,type:f,url:a._settings.DeleteUrl,data:$$WPUtil.postify(b)}).success($.proxy(a.__deleteSuccess,a,c)).fail($.proxy(a.__deleteFail,a))},__deleteSuccess:function _deleteFile(c,b){var a=this;if(b.Success){if(c){a._documentCollection.remove(c);a._refreshView();a._viewContainer$.find(".addItem a").focus();if(a.__isFunction(a._settings.onDeleteSuccess))a._settings.onDeleteSuccess(c,b)}}else a.__deleteFail(b)},__deleteFail:function __deleteFail(a){this._handleCommunicationFail(h.DeleteFile,a)},_refreshView:function _refreshView(d){var a=this;if($.isFunction(a._settings.RefreshViewOverride)){a._settings.RefreshViewOverride.call(a,a);return}var c={Configuration:a._settings,IsCurrentlyUploading:g,IsLimitReached:a._documentCollection.Models.length>=a._settings.MaxFilesAllowed,IsConfigLoading:a._isConfigLoaded===b,CanUpload:!g&&a._documentCollection.Models.length<a._settings.MaxFilesAllowed&&a._isConfigLoaded};$$WP.Strings.setDefaultNamespace(a._settings.DefaultStringNamespace);c.Documents=a._documentCollection.Models;if(d)a._viewContainer$.find(".upload-addFile").safeReplaceWith($afe.renderTemplate(a._settings.UploadCardTemplate,c));else a._viewContainer$.empty().safeAppend($afe.renderTemplate(a._settings.ViewTemplate,c));$$WP.Strings.clearDefaultNamespace();a._viewContainer$.find(".cardlist").trigger("cardLoad");$afe.jq(window).trigger("matchColumnHeights");$.isFunction(a.__afterRefreshView)&&a.__afterRefreshView()},_attachEventHandlers:function _attachEventHandlers(){var b="[data-dragregion]",a=this;a.__isFunction(a._settings.AttachContainerEventHandlers)&&a._settings.AttachContainerEventHandlers();a.__isFunction(a._settings.AttachFileCardEventHandlers)&&a._settings.AttachFileCardEventHandlers();a._viewContainer$.on("click keypress",m,a._onAddButtonClicked);a._viewContainer$.on(i,"[data-function='remove']",a._onRemoveButtonClicked);a._viewContainer$.on(i,"[data-function='view']",a._onViewButtonClicked);a._viewContainer$.on("change","[data-function='upload-core']",a._uploadFile);a._viewContainer$.on(i,"[data-function='edit-label']",a._onEditButtonClicked);a._viewContainer$.on("blur",j,a._onFileNameEdited);a._viewContainer$.on(q,j,a._onFileNameInputKeyPressed);a._viewContainer$.on("dragover drop dragenter dragleave dragstart dragend",b,function(a){a.stopPropagation();a.preventDefault()});a._viewContainer$.on("dragover",b,function(a){a.originalEvent.dataTransfer.dropEffect="copy"});a._viewContainer$.on("drop",b,a.__onDropFiles);a._viewContainer$.on("dragover dragenter",b,a.__onDragEnter);a._viewContainer$.on("dragleave dragend",b,a.__onDragLeave)},__onDropFiles:function __onDropFiles(b){var a=b.originalEvent.dataTransfer.files||[];this.__uploadFileCore(a)},__onDragEnter:function __onDragEnter(){this._viewContainer$.find(m).addClass("hover")},__onDragLeave:function __onDragLeave(){this._viewContainer$.find(m).removeClass("hover")},_onFileNameEdited:function _onFileNameEdited(d){var c=$afe.jq(d.target).closest("input"),b=(c.val()||"").trim(),a=$$WP.Common.Model.getInstance(c.data(k));if(b.length>0&&b.length<=100&&a&&b!==a.FileDisplayName){a.FileDisplayName=b;this._editFileName(a);this._refreshView()}else{c.val(a.FileDisplayName);c.closest("[data-is-editing]").safeAttr(r,"false")}},_onFileNameInputKeyPressed:function _onFileNameInputKeyPressed(a){var b=a.which||a.keyCode;if(b===13){a.stopPropagation();this._viewContainer$.find(j).trigger("blur")}},_onAddButtonClicked:function _onAddButtonClicked(f){var b="Upload",c=this;if(f.type===q&&f.keyCode!==13)return;f.stopPropagation();f.stopImmediatePropagation();f.preventDefault();if(g){new $$WPUtil.quickMessageBox($$WP.Strings.get(p,b),$$WP.Strings.get(d,b),[new $$WPComp.ComplexObjects.Button($$WP.Strings.get(e,b),a,s,t)]);return}if(c._settings.NeedsRedirect){$$WPUtil.SafeToRedirectOverrideSettings={TitleText:c._settings.RedirectTitle,Html:c._settings.RedirectHtml};$$WPUtil.SafeToRedirect($.proxy(c._continueUpload,c))}else c._triggerInputClick()},_triggerInputClick:function _triggerInputClick(){this._viewContainer$.find("input[type='file'][data-function='upload-core']").trigger(i)},_continueUpload:function _continueUpload(a){$$WPUtil.SafeToRedirectOverrideSettings={};if(!a)return;this._triggerInputClick()},_onRemoveButtonClicked:function _onRemoveButtonClicked(f){var b="@MYCHART@DOCUMENTNAME@",e=$afe.jq(f.target),c=$$WP.Common.Model.getInstance(e.data(k));$$WP.Strings.setDefaultNamespace(this._settings.DefaultStringNamespace);$$WP.Strings.addMnemonic(b,c.FileDisplayName);var d=[new $$WPComp.ComplexObjects.Button($$WP.Strings.get("DocumentRemovePopupRemoveButtonText"),a,"inlinedelete","remove"),new $$WPComp.ComplexObjects.Button($$WP.Strings.get("DocumentRemovePopupGoBackButtonText"),a,"cancel","cancel")];new $$WPUtil.quickMessageBox($$WP.Strings.get("DocumentRemovePopupDescriptionText"),$$WP.Strings.get("DocumentRemovePopupHeaderText"),d,$.proxy(this._onRemovePopupButtonClicked,this),[c]);$$WP.Strings.removeMnemonic(b);$$WP.Strings.clearDefaultNamespace()},_onRemovePopupButtonClicked:function _onRemovePopupButtonClicked(a,b){b===$$WPComp.TOOLBARIDENTIFIER+"remove"&&this._deleteFile(a)},_onEditButtonClicked:function _onEditButtonClicked(a){a.stopPropagation();a.preventDefault();var c=$afe.jq(a.target),d=$$WP.Common.Model.getInstance(c.data(k)),b=this._viewContainer$.find("[data-document-id='"+d.DocumentId+"'][data-is-editing]");b.safeAttr(r,"true");b.find(j).focus()},_onViewButtonClicked:function _onViewButtonClicked(d){d.stopPropagation();d.preventDefault();var f=$afe.jq(d.target),c=$$WP.Common.Model.getInstance(f.data(k)),e=new $$WP.Documents.ViewDocument.Models.DocumentModel(a,{},encodeURIComponent(c.FileReference),encodeURIComponent(c.DocumentId),c.FileDisplayName,c.FileExtensionWithoutDot,a,a,a,a,a,a,a,a,a,a,encodeURIComponent(this._settings.ViewerCsn));if(!c.AllowPreview)e.AllowPreview=b;e.openDocument("uploadWidget sm-autosizedpopup")},getAllDocuments:function getAllDocuments(){return this._documentCollection.Models},getDocumentCollection:function getDocumentCollection(){return this._documentCollection},getUploadContextData:function getUploadContextData(){var b=a;if(!$$WPUtil.IsNullOrEmpty(this._settings))b=this._settings.ContextData;return b},DeleteFile:function DeleteFile(a){this._deleteFile(a)},RefreshView:function RefreshView(a){this._refreshView(a)},_serializeContextToFormData:function _serializeContextToFormData(c,b){var a;if(b)for(a in b)c.append(a,b[a])},_handleCommunicationFail:function _handleCommunicationFail(g,f){var a=this,e=c,d="";switch(g){case h.GetConfig:e=a.__isFunction(a._settings.onConfigFail)?a._settings.onConfigFail(f):c;d="ServerErrorPopupDescriptionGetConfigFailedText";break;case h.UploadFile:e=a.__isFunction(a._settings.onUploadFail)?a._settings.onUploadFail(f):c;d="ServerErrorPopupDescriptionUploadFileFailedText";break;case h.EditFileName:e=a.__isFunction(a._settings.onEditFail)?a._settings.onEditFail(f):c;d="ServerErrorPopupDescriptionEditFileFailedText";break;case h.DeleteFile:e=a.__isFunction(a._settings.onDeleteFail)?a._settings.onDeleteFail(f):c;d="ServerErrorPopupDescriptionDeleteFileFailedText"}e!==b&&a._showErrorMessage(d,"ServerErrorPopupHeaderText","ServerErrorPopupButtonText")},_showErrorMessage:function _showErrorMessage(h,i,j){var g="@MYCHART@ALLOWEDVIDEOSIZE@",f="@MYCHART@ALLOWEDIMAGESIZEKB@",e="@MYCHART@ALLOWEDIMAGESIZE@",d="@MYCHART@ALLOWEDEXTENSIONS@",c="@MYCHART@MAXUPLOADS@",b=this;$$WP.Strings.setDefaultNamespace(b._settings.DefaultStringNamespace);$$WP.Strings.addMnemonic(c,b._settings.MaxFilesAllowed);$$WP.Strings.addMnemonic(d,b._settings.AllowedExtensions.join(", "));$$WP.Strings.addMnemonic(e,Math.floor(b._settings.MaxAllowedImageSize*10/1024)/10);$$WP.Strings.addMnemonic(f,b._settings.MaxAllowedImageSize);$$WP.Strings.addMnemonic(g,Math.floor(b._settings.MaxAllowedVideoSize*10/1024)/10);if(h==o&&b._settings.AllowedExtensions.length==0)h="FileNotAcceptedPopupWrongExtensionErrorTextNoExtensions";new $$WPUtil.quickMessageBox($$WP.Strings.get(h),$$WP.Strings.get(i),[new $$WPComp.ComplexObjects.Button($$WP.Strings.get(j),a,s,t)],function(){$afe.select(".upload-addFile a").focus()});$$WP.Strings.removeMnemonic(g);$$WP.Strings.removeMnemonic(e);$$WP.Strings.removeMnemonic(f);$$WP.Strings.removeMnemonic(d);$$WP.Strings.removeMnemonic(c);$$WP.Strings.clearDefaultNamespace();b._refreshView()},__isFunction:function __isFunction(a){return a&&typeof a==="function"}};var g=b,h={GetConfig:1,UploadFile:2,EditFileName:3,DeleteFile:4},v=function IsCurrentlyUploading(){return g};$$WP.Upload.Controllers.UploadController=u;$$WP.Upload.Controllers.IsCurrentlyUploading=v;u.extend($$WP.Controllers.Controller,"$$WP$Upload$Controllers$UploadController")})()