(function ClassDefinition(){var i="margin-top",j="show-menu",g="aria-expanded",d=".defaultajaxoverlay",f="aria-hidden",h="#proxyMenuShield",b=true,e="true",a=false,c=null;$$WP.Utilities.guaranteeExistence($$WP,"ProxySwitch.Controllers");var k=function WP$ProxySwitch$Controllers$ProxySelectorController(b){var a=this;a.$switchRoot=b;a.strings=$$WP.Strings.getNamespace("ProxySwitch.ProxySwitch.ProxySelector");a.lastCloseTime=0;a.photoTemplate=$$WP.Templates.ProxySwitch.PatientRoundIcon;a.switchTemplate=$$WP.Templates.ProxySwitch.DropDownProxySelector;$.ajax({url:makeLink("ProxySwitch"),success:a._onModelLoaded.bind(a),type:"GET",dataType:"JSON"});a.keyCode={TAB:9,RETURN:13,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40};a.proxify("_showPhotoConfirmationCore")},l={$switchRoot:c,switchTemplate:c,modelData:c,photoTemplate:c,popupMenuController:a,dontReopen:a,$popupMenu:c,$menuButton:c,strings:c,lastCloseTime:0,uploadController:c,_onModelLoaded:function WP$ProxySwitch$Controllers$ProxySelectorController$_onModelLoaded(a){this.modelData=new $$WP.ProxySwitch.Models.ProxySelectorViewModel(a);this._render()},_render:function WP$ProxySwitch$Controllers$ProxySelectorController$_render(){var a=this;a._registerPartialTemplates();a.$switchRoot.safeAppend($afe.renderTemplate(a.switchTemplate,a.modelData,{}));a.$menuButton=a.$switchRoot.find("#proxyMenuButton");a.$menuButton.safeAttr("aria-haspopup",e);a.$popupMenu=$("#"+a.$menuButton.safeAttr("aria-controls"));$afe.jq(window).on("resize",$.proxy(a._onResize,a));if(a.$popupMenu.length===1)a.popupMenuController=new $$WP.ProxySwitch.Controllers.ProxyPopupMenuController(a.$popupMenu,a);a._onResize();a.modelData.ShowPhotoUpload===b&&a._createUploadController();a.$menuButton.on("click",a._handleClick.bind(a));$afe.select(h).on("click",a._handleClick.bind(a));a.$menuButton.on("keydown",a._handleKeydown.bind(a));WP.DOM.Browser.isIE&&$afe.select(".proxySelectorDropDownNameEllipsis").safeAttr(f,"false")},_onResize:function WP$ProxySwitch$Controllers$ProxySelectorController$_onResize(){var a=this;if(!a.modelData.ShowDropDown)return;var b=a.$switchRoot.find("#proxySwitchNav");if(!a.$menuButton||a.$menuButton.length<1||!b||b.length<1)return;var c=a.$menuButton[0].getBoundingClientRect().height;if(b.css("position")==="fixed"){var d=a.$menuButton[0].getBoundingClientRect().top;b.css("top",d+c);return}else b.css("top",c)},_registerPartialTemplates:function WP$ProxySwitch$Controllers$ProxySelectorController$_registerPartialTemplates(){Handlebars.registerPartial("roundPatientIcon",$$WP.Templates.ProxySwitch.PatientRoundIcon)},_createUploadController:function WP$ProxySwitch$Controllers$ProxySelectorController$_createUploadController(){var c=this,d={};d.ViewTemplate=$$WP.Templates.ProxySwitch.DropDownProxySelector;var a=new $$WP.Upload.Models.UploadConfiguration(d);a.ConfigUrl=makeLink("ProxySwitch/ProxyPhotoUpload/GetFileUploadConfiguration");a.UploadUrl=makeLink("ProxySwitch/ProxyPhotoUpload/UploadFile");a.ConfirmationViewModel=c.modelData.CurrentlySelected;a.MasterController=c;a.ConfirmFunction=c._findExifAndShowConfirmationPopup;a.RefreshViewOverride=c._updateFileSelector;a.onUploadSuccess=c._refreshPage;a.onUploadFail=c._hideLoading;a.NeedsRedirect=b;a.RedirectTitle=c.strings.getString("photoUploadUnsavedChangesPopupTitle");a.RedirectHtml=c.strings.getString("photoUploadUnsavedChangesPopupText");a.UseGet=b;a.onConfigSucess=$.proxy(c._hidePhotoUploadIfInvalid,c);a.FromVBPage=b;c.uploadController=new $$WP.Upload.Controllers.UploadController($afe.select("#patientPhotoListItem"),a)},_hidePhotoUploadIfInvalid:function WP$ProxySwitch$Controllers$ProxySelectorController$_hidePhotoUploadIfInvalid(){var a=this;if(!a.uploadController._settings.AllowedImageAndDocumentExtensions||a.uploadController._settings.AllowedImageAndDocumentExtensions.length<1){a.modelData.resetPhotoUploadToFalse();a.$switchRoot.empty();a._render()}},_updateFileSelector:function WP$ProxySwitch$Controllers$ProxySelectorController$_updateFileSelector(c){var a="#patientPhotoFileInput";if(!c||!c._settings||!Array.isArray(c._settings.AllowedImageAndDocumentExtensions))return;$afe.select(a).replaceWith($afe.select(a)).val("").clone(b);$afe.select(a).safeAttr("accept","image/"+c._settings.AllowedImageAndDocumentExtensions.join(",image/"))},_refreshPage:function WP$ProxySwitch$Controllers$ProxySelectorController$_refreshPage(){$$WPUtil.ShowAjaxSpinner($afe.select(".ajaxspinner"));$$WPUtil.TryRedirect(makeLink("inside.asp?mode=HttpModule&State="+self.location.pathname.substring(WP.myPath.length)+encodeURIComponent(self.location.search)+"&RebuildMenu=1"))},_hideLoading:function WP$ProxySwitch$Controllers$ProxySelectorController$_hideLoading(){$$WPUtil.HideAjaxSpinner($afe.select(d))},_findExifAndShowConfirmationPopup:function WP$ProxySwitch$Controllers$ProxySelectorController$_findExifAndShowConfirmationPopup(b,e,d,c){var a={};a.viewModel=e;a.successCallback=d;a.uploadController=c;a.inpFile=b;this._getExifTag(b,this._showPhotoConfirmationPopup.bind(this),a)},_showPhotoConfirmationPopup:function WP$ProxySwitch$Controllers$ProxySelectorController$_showPhotoConfirmationPopup(e,i){var c=e.inpFile,h=e.viewModel,g=e.successCallback,f=e.uploadController;if(i||c.name.toLowerCase().indexOf(".tif",c.name.length-5)!==-1){formData=new FormData;formData.append("__file__[]",c);$$WPUtil.ShowAjaxSpinner($afe.select(d));$.ajax({dataType:"json",type:"POST",processData:a,contentType:a,url:makeLink("ProxySwitch/ProxyPhotoUpload/ConvertToJpegRemoveExif"),data:formData}).success($.proxy(function(a){$$WPUtil.HideAjaxSpinner($afe.select(d));this._showPhotoConfirmationCore(b,c,h,g,f,a.bytes),this},this))}else this._showPhotoConfirmationCore(a,c,h,g,f)},_getExifTag:function WP$ProxySwitch$Controllers$ProxySelectorController$_getExifTag(e,b,c){var d=new FileReader;d.onload=function(n){var f=this,e=new DataView(n.target.result);if(e.getUint16(0)!=65496)return b(c,a);var l=e.byteLength,d=2;while(d<l){if(f._safeGetUint(e,d+2,16,a)<=8)return b(c,a);var j=f._safeGetUint(e,d,16,a);d+=2;if(j==65505){if(f._safeGetUint(e,d+=2,32,a)!=1165519206)return b(c,a);var h=f._safeGetUint(e,d+=6,16,a)==18761,g=f._safeGetUint(e,d+4,32,h);if(g===-1)break;d+=g;var m=f._safeGetUint(e,d,16,h);d+=2;for(var i=0;i<m;i++)if(f._safeGetUint(e,d+i*12,16,h)==274){var k=f._safeGetUint(e,d+i*12+8,16,h);return b(c,k>=2)}}else if((j&65280)!=65280)break;else{var g=f._safeGetUint(e,d,16,a);if(g===-1)break;d+=g}}return b(c,a)}.bind(this);d.readAsArrayBuffer(e)},_safeGetUint:function WP$ProxySwitch$Controllers$ProxySelectorController$_safeGetUint(c,b,d,a){try{return d===16?c.getUint16(b,a):c.getUint32(b,a)}catch(e){return-1}},_showPhotoConfirmationCore:function WP$ProxySwitch$Controllers$ProxySelectorController$_showPhotoConfirmationCore(t,l,n,r,q,v){var k="#proxyPhotoPreview",j="ServiceAreas",i="@MYCHART@ALLOWEDAREAS@",h="@MYCHART@PHOTO_FILENAME@",g="@MYCHART@SUBJECT_PATIENTNAME@",a=this;a.strings.addMnemonic(g,a.modelData.CurrentlySelected.DisplayName);a.strings.addMnemonic(h,l.name,$$WP.Strings.EncodingTypes.None);a.strings.addMnemonic(i,a.modelData.CurrentlySelected.ServiceAreaAbbreviationList,$$WP.Strings.EncodingTypes.None);var f,u=[new $$WPComp.ComplexObjects.Button(a.strings.getString("photoConfirmationPopupAcceptButton"),c,"nextstep","continue"),new $$WPComp.ComplexObjects.Button(a.strings.getString("photoConfirmationPopupCancelButton"),c,"inlinedelete","stop")],e;if(a.modelData.CurrentlySelected.IsSelf){f=a.uploadController._settings.IsPhotoForPatientsChart?"photoUploadConfirmationSelf":"photoUploadConfirmationSelfMyChartOnly";e=a.uploadController._settings.IsPhotoForPatientsChart?"photoUploadScreenReaderConfirmationSelf":"photoUploadScreenReaderConfirmationSelfMyChartOnly"}else{f=a.uploadController._settings.IsPhotoForPatientsChart?"photoUploadConfirmationSubject":"photoUploadConfirmationSubjectMyChartOnly";e=a.uploadController._settings.IsPhotoForPatientsChart?"photoUploadScreenReaderConfirmationSubject":"photoUploadScreenReaderConfirmationSubjectMyChartOnly"}if(a.modelData.CurrentlySelected.ServiceAreaAbbreviationList){f+=j;e=j}var m=a.strings.getString(f),p=a.strings.getString(e);a.strings.removeMnemonic(g);a.strings.removeMnemonic(h);a.strings.removeMnemonic(i);m="<span id='proxyPhotoPreview' class='largePhoto'></span>  <span class='clearlabel'>"+p+"</span><span aria-hidden='true'>"+m+"</span> ";var s=a.strings.getString("UploadingPhoto"),o=URL.createObjectURL(l);n.PhotoUrl=o;$$WPUtil.quickMessageBox(m,a.strings.getString("uploadPhotoTitle"),u,function(a,b,e,f,g,c){URL.revokeObjectURL(f);if(c!=="toolbarcontinue")return;$$WPUtil.ShowAjaxSpinner($afe.select(d));b.call(a,e)},[q,r,l,o,s],"photoUploadConfirmationComponent");if(t){var w=new Blob([new Uint8Array(v)],{type:"image/jpeg"}),o=URL.createObjectURL(w);n.PhotoUrl=o}$afe.select(k).safeAppend($afe.renderTemplate($$WP.Templates.ProxySwitch.PatientRoundIcon,n));$afe.select(k).safeAttr("aria-label",l.name);a._updateFileSelector(a.uploadController);return b},_handleKeydown:function WP$ProxySwitch$Controllers$ProxySelectorController$_handleKeydown(d){var c=this;if(c.modelData.IsGuest)return;var f=a;if(!c.modelData.ShowDropDown===b&&(d.keyCode===c.keyCode.SPACE||d.keyCode===c.keyCode.RETURN)){$$WPUtil.TryRedirect(makeLink("Home"));return}switch(d.keyCode){case c.keyCode.SPACE:case c.keyCode.RETURN:if(c.popupMenuController){c.openProxyDropdown();c.popupMenuController.setFocusToFirstItem()}f=b;break;case c.keyCode.ESC:if(c.popupMenuController&&c.$menuButton.safeAttr(g)===e){c.closeProxyDropdown();f=b}}if(f){d.stopPropagation();d.preventDefault()}},_handleClick:function WP$ProxySwitch$Controllers$ProxySelectorController$_handleClick(d){var c=this;if(c.modelData.IsGuest)return;!c.modelData.ShowDropDown===b&&$$WPUtil.TryRedirect(makeLink("Home"));if(c.dontReopen)c.dontReopen=a;if(c.$menuButton.safeAttr(g)===e)c.closeProxyDropdown();else{c.openProxyDropdown();var f=document.getElementById("proxyMenuButton").getBoundingClientRect(),h=Math.round((f.left+f.right)/2),i=Math.round((f.top+f.bottom)/2);(d.screenX===0&&d.screenY===0||d.clientX===h&&d.clientY===i)&&c.popupMenuController.setFocusToFirstItem()}},openProxyDropdown:function WP$ProxySwitch$Controllers$ProxySelectorController$openProxyDropdown(){var a=this;if(+new Date-a.lastCloseTime<250)return;a._onResize();a.$switchRoot.addClass(j);a.$menuButton.safeAttr(g,e);$afe.select(h).fadeIn("fast");a.__setAriaHiddenForPage(b);window.innerWidth>1024&&$afe.select("body").css(i,-$$WPUtil.getScrollTop());$$WP.Utilities.UI.ToggleBodyScrolling(b);$afe.select("#proxyList")[0].scrollTop=0},closeProxyDropdown:function WP$ProxySwitch$Controllers$ProxySelectorController$closeProxyDropdown(){var b=this;b.$switchRoot.removeClass(j);b.$menuButton.safeAttr(g,"false");var c=$afe.select("body"),d=-parseInt(c.css(i));$afe.select(h).fadeOut("fast");$$WP.Utilities.UI.ToggleBodyScrolling(a);if(window.innerWidth>1024){c.css(i,"");$$WPUtil.setScrollTop(d)}b.lastCloseTime=+new Date;b.__setAriaHiddenForPage(a)},__setAriaHiddenForPage:function WP$ProxySwitch$Controllers$ProxySelectorController$__setAriaHiddenForPage(a){$afe.select("#footer").safeAttr(f,a);$afe.select("#content").safeAttr(f,a);$afe.select("#toastWrapper").safeAttr(f,a)}};k.prototype=l;$$WP.ProxySwitch.Controllers.ProxySelectorController=k;k.extend($$WP.Controllers.Controller,"WP$ProxySwitch$Controllers$ProxySelectorController")})()